# 13. 교착상태


## 13-1 교착상태란

교착상태 : 프로세스들이  꼼짝 못하고 정지해버리는 상태 (deadlock)

- 식사하는 철학자 문제 (dining philosophers problem)
  - 철학자 5 포크 5 개 주어짐
  - 왼쪽 오른쪽 사용가능할때 집어들고 식사시작
  - 그런데 모든 철학자들이 동시에 식사를 시작하려면?
    - 영원히 생각만 하는 상황 발생
  - 여기서 포크는 임계구역이라 볼 수 있음
  
![img src](https://user-images.githubusercontent.com/49462767/226121275-383c33d6-a18b-4818-af64-089a389a6d1f.png)


### 자원 할당 그래프

1. 프로세스는 원으로 자원은 사각형으로 표현
2. 사용할 수 있는 자원의 개수는 사각형 내에 점으로 표시
3. 프로세스가 자원을 할당받아 사용중이라면 자원에서 프로세서로 화살표(여기선 검정색)
4. 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표(여기선 빨간색)

### 교착상태 발생 조건

- 상호 배제
  - 하나의 포크를 여럿이서 사용 가능했다면 애당초 교착상태가 일어나지 않았을 것
  - 한 프로세스가 사용하는 자원  다른 프로세스가 사용 못할 때 교착상태 발생
- 점유와 대기
  - '왼쪽 포크를 들고' 오른쪽 포크를 들어야 식사가능한 조건은 일단 일정한 자원을 점유한채로 대기하는것
  - 자원을 할당 받은 상태에서 다른 자원을 할당받기를 기다리는 상태
  - hold and wait
- 비선점
  - nonpreemptive
  - 철학자가 다른 철학자의 포크를 뺏을 수 있었다면 누구든 식사를 시작했고 교착 상태가 일어나지 않았을 것
  - 프로세스도 마찬가지 (자원을 뺏었다면)
- 원형 대기
  - 자원할당 그래프가 원을 그린다면
  - circular wait

## 13-2 교착상태 해결 방법


### 교착상태 예방법
- 위에서 언급한 조건을 만족시키지 않게 하는 것이 예방법

- 상호배제 없애긴 무리
- 점유와 대기를 없애면 운영체제는 특정 프로세스에 자원을 모두 할당하거나 아예 할당하지 않음
  - 자원의 활용률 낮음
  - starvation 현상의 위험
- 비선점 제거
  - 선점하여 사용할 수 있는 자원에 대해서는 효과적 CPU
  - 선점할 수 없는 자원도 있음 (프린터 등등)
- 원형 대기 제거
  - 비교적 현실적
  - 포크 (자원) 에 번호를 붙이고 오름차순으로 들게하는 규칙 (5번 포크와 1번포크 집을 수 없음)
  - 원형의 고리를 끊어냄
  - 하지만 모든 자원에 숫자를 붙이는건 꽤나 힘듬

### 교착상태 회피

- 교착 발생하지 않을정도로만 자원 할당
- 교착상태를 무분별한 할당으로 인해 발생하는 문제로 간주
- 프로세스들에 배분할 수 있는 자원의 양을 고려하여 교착 상태가 발생하지 않을 정도만 자원을 배분하는 방법
  - 프로세스는 자원을 운영체제에 요청 -> 운영체제로부터 자원 할당 -> 자원사용 끝났다면 자원 반환

- 안전상태
  - 모든 프로세스 정상 할당 정상 종료 가능
- 불안전 상태
  - 교착 발생 가능성 있음
  - 안전 순서열 없음
- 안전 순서열
  - 안전하게 프로세스들에 자원을 할당할 수 있는 순서를 의미
- 운영체제가 교착상태를 회피하기 위해선 안전상태로 움직이는 경우에만 자원을 할당하면 됨


### 교착상태 검출 후 회복

- 선점을 통한 회복
  - 교착이 해결될때까지 한 프로세스에 자원 몰빵

- 프로세스 강제 종료를 통한 회복
  - 가장 단순하면서 확실한 방식
    - 프로세스 모두 강제종료
      - 작업의 유실가능성 있음
    - 교착상태 없어질 때까지 프로세스 하나씩 종료 
      - 교착상태 검증하는 오버헤드 발생
- 타조 알고리즘
  - 교착상태 무시하는 방법


이러한 해결책이 완벽한 해결방식은 아니나 엔지니어 입장에서 꽤 적합할때도 많음

